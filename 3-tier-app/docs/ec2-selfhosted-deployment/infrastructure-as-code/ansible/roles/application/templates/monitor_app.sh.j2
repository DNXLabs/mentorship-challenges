#!/bin/bash
# Application monitoring script for {{ app.name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

echo "=== {{ app.name | upper }} MONITORING DASHBOARD ==="
echo "Timestamp: $(date)"
echo "Server: {{ inventory_hostname }}"
echo

echo "=== PM2 STATUS ==="
pm2 status

echo
echo "=== APPLICATION HEALTH ==="
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:{{ app.port }}/api/submissions)
if [ "$API_STATUS" = "200" ]; then
    echo "✅ API Health: OK (HTTP $API_STATUS)"
else
    echo "❌ API Health: FAILED (HTTP $API_STATUS)"
fi

echo
echo "=== DATABASE CONNECTION ==="
DB_STATUS=$(mysql -u {{ database.user }} -p{{ database.password }} -h {{ database.host }} -e "SELECT 1;" {{ database.name }} 2>/dev/null && echo "OK" || echo "FAILED")
if [ "$DB_STATUS" = "OK" ]; then
    echo "✅ Database: Connected"
else
    echo "❌ Database: Connection Failed"
fi

echo
echo "=== SYSTEM RESOURCES ==="
echo "Memory Usage:"
free -h
echo
echo "Disk Usage:"
df -h /
echo
echo "CPU Load:"
uptime

echo
echo "=== RECENT LOGS ==="
echo "Last 5 application log entries:"
tail -5 {{ app.logs_dir }}/{{ pm2.app_name }}.log 2>/dev/null || echo "No logs found"

echo
echo "=== NGINX STATUS ==="
systemctl is-active nginx && echo "✅ Nginx: Running" || echo "❌ Nginx: Not Running"

echo
echo "=== QUICK ACTIONS ==="
echo "Restart API: pm2 restart {{ pm2.app_name }}"
echo "View logs: pm2 logs {{ pm2.app_name }}"
echo "Check nginx: sudo systemctl status nginx"
echo "Check database: sudo systemctl status mysql"
