#!/bin/bash
# Database backup script for {{ app.name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

set -e

BACKUP_DIR="{{ app.backups_dir }}"
DB_NAME="{{ database.name }}"
DB_USER="{{ database.user }}"
DB_PASSWORD="{{ database.password }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/db_backup_${TIMESTAMP}.sql"
RETENTION_DAYS={{ backup.retention_days }}

# Create backup
echo "Creating database backup: ${BACKUP_FILE}"
mysqldump -u "${DB_USER}" -p"${DB_PASSWORD}" "${DB_NAME}" > "${BACKUP_FILE}"

# Compress backup
gzip "${BACKUP_FILE}"
echo "Backup compressed: ${BACKUP_FILE}.gz"

# Remove old backups
echo "Cleaning up backups older than ${RETENTION_DAYS} days"
find "${BACKUP_DIR}" -name "db_backup_*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# Log backup completion
echo "$(date): Database backup completed successfully" >> "${BACKUP_DIR}/backup.log"

echo "Database backup completed successfully!"
