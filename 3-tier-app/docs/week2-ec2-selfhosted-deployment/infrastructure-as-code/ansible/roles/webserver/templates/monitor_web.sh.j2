#!/bin/bash
# Web server monitoring script for {{ app.name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

echo "=== WEB SERVER MONITORING ==="
echo "Timestamp: $(date)"
echo

echo "=== NGINX STATUS ==="
systemctl status nginx --no-pager -l

echo
echo "=== WEB APPLICATION TESTS ==="
echo "Testing main page..."
MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
if [ "$MAIN_STATUS" = "200" ]; then
    echo "✅ Main page: OK (HTTP $MAIN_STATUS)"
else
    echo "❌ Main page: FAILED (HTTP $MAIN_STATUS)"
fi

echo "Testing admin panel..."
ADMIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/admin.html)
if [ "$ADMIN_STATUS" = "200" ]; then
    echo "✅ Admin panel: OK (HTTP $ADMIN_STATUS)"
else
    echo "❌ Admin panel: FAILED (HTTP $ADMIN_STATUS)"
fi

echo "Testing API proxy..."
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/submissions)
if [ "$API_STATUS" = "200" ]; then
    echo "✅ API proxy: OK (HTTP $API_STATUS)"
else
    echo "❌ API proxy: FAILED (HTTP $API_STATUS)"
fi

echo
echo "=== NGINX CONFIGURATION TEST ==="
nginx -t

echo
echo "=== ACCESS LOG (Last 10 entries) ==="
tail -10 {{ nginx.access_log }} 2>/dev/null || echo "No access log found"

echo
echo "=== ERROR LOG (Last 5 entries) ==="
tail -5 {{ nginx.error_log }} 2>/dev/null || echo "No error log found"

echo
echo "=== NGINX PROCESSES ==="
ps aux | grep nginx | grep -v grep
