#!/bin/bash
# Log analysis script for {{ app.name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

echo "=== LOG ANALYSIS FOR {{ app.name | upper }} ==="
echo "Analysis timestamp: $(date)"
echo

# Analyze Nginx access logs
echo "=== NGINX ACCESS LOG ANALYSIS ==="
if [ -f "{{ nginx.access_log }}" ]; then
    echo "Top 10 IP addresses:"
    awk '{print $1}' {{ nginx.access_log }} | sort | uniq -c | sort -nr | head -10
    
    echo
    echo "Top 10 requested URLs:"
    awk '{print $7}' {{ nginx.access_log }} | sort | uniq -c | sort -nr | head -10
    
    echo
    echo "HTTP status codes:"
    awk '{print $9}' {{ nginx.access_log }} | sort | uniq -c | sort -nr
else
    echo "No access log found"
fi

echo
echo "=== NGINX ERROR LOG ANALYSIS ==="
if [ -f "{{ nginx.error_log }}" ]; then
    echo "Recent errors (last 10):"
    tail -10 {{ nginx.error_log }}
else
    echo "No error log found"
fi

echo
echo "=== APPLICATION LOG ANALYSIS ==="
if [ -f "{{ app.logs_dir }}/{{ pm2.app_name }}.log" ]; then
    echo "Recent application logs (last 10):"
    tail -10 {{ app.logs_dir }}/{{ pm2.app_name }}.log
    
    echo
    echo "Error count in application logs:"
    grep -i error {{ app.logs_dir }}/{{ pm2.app_name }}.log | wc -l
else
    echo "No application log found"
fi

echo
echo "=== SYSTEM LOG ANALYSIS ==="
echo "Recent system errors:"
journalctl --since "1 hour ago" --priority=err --no-pager | tail -5

echo
echo "=== LOG ANALYSIS COMPLETE ==="
