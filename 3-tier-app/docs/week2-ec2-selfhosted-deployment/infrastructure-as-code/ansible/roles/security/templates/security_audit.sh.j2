#!/bin/bash
# Security audit script for {{ app.name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo "[$TIMESTAMP] Starting security audit"

# Check for failed login attempts
echo "=== Failed Login Attempts (last 24 hours) ==="
grep "Failed password" /var/log/auth.log | grep "$(date '+%b %d')" | wc -l

# Check fail2ban status
echo "=== Fail2ban Status ==="
fail2ban-client status

# Check open ports
echo "=== Open Ports ==="
netstat -tuln | grep LISTEN

# Check running processes
echo "=== Suspicious Processes ==="
ps aux | grep -E "(nc|netcat|nmap|tcpdump)" | grep -v grep || echo "None found"

# Check file permissions on sensitive files
echo "=== File Permissions Audit ==="
ls -la {{ app.app_dir }}/.env {{ app.app_dir }}/api/.env /root/.my.cnf 2>/dev/null

# Check for world-writable files
echo "=== World-writable Files ==="
find {{ app.app_dir }} -type f -perm -002 2>/dev/null || echo "None found"

# Check UFW status
echo "=== UFW Firewall Status ==="
ufw status

# Check for package updates
echo "=== Available Security Updates ==="
apt list --upgradable 2>/dev/null | grep -i security | wc -l

echo "[$TIMESTAMP] Security audit completed"
